openapi: 3.0.3
info:
  title: Recipe Tracker API
  version: 1.0.0
  description: REST API for recipes, ingredients, collections, reviews, authentication, and user management.

servers:
  - url: http://localhost:3000
    description: Local development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    User:
      type: object
      properties:
        userid:
          type: integer
          example: 1
        username:
          type: string
          example: jasmine_biggs
        email:
          type: string
          format: email
          example: jb@example.com
        role:
          type: string
          enum: [USER, CREATOR, ADMIN]

    AuthToken:
      type: object
      properties:
        accessToken:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    AuthSignupMessage:
      type: object
      properties:
        message:
          type: string
          example: New user created with an id of 42

    Ingredient:
      type: object
      properties:
        ingredient_id:
          type: integer
          example: 12
        name:
          type: string
          example: flour
        unit:
          type: string
          nullable: true
          example: grams
      required: [ingredient_id, name]

    Step:
      type: object
      properties:
        order:
          type: integer
          example: 1
        text:
          type: string
          example: Mix all dry ingredients
      required: [order, text]

    RecipeIngredient:
      type: object
      properties:
        ingredientId:
          type: integer
          example: 12
        name:
          type: string
          example: sugar
        unit:
          type: string
          nullable: true
          example: grams
      required: [ingredientId, name]

    RecipeSummary:
      type: object
      properties:
        id:
          type: integer
          example: 3
        title:
          type: string
          example: Fluffy Pancakes
        isPublic:
          type: boolean
          example: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, title, isPublic]

    RecipeDetail:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
          nullable: true
        isPublic:
          type: boolean
        ownerId:
          type: integer
        servings:
          type: integer
          nullable: true
        prepMinutes:
          type: integer
          nullable: true
        cookMinutes:
          type: integer
          nullable: true
        steps:
          type: array
          items:
            $ref: '#/components/schemas/Step'
        ingredients:
          type: array
          items:
            $ref: '#/components/schemas/RecipeIngredient'
        tags:
          type: array
          items:
            type: string
            example: breakfast
      required: [id, title, isPublic]

    Collection:
      type: object
      properties:
        collection_id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 4
        name:
          type: string
          example: Jasmine's Saved Recipes

    CollectionItem:
      type: object
      properties:
        collection_item_id:
          type: integer
          example: 10
        collection_id:
          type: integer
          example: 1
        recipe_id:
          type: integer
          example: 2
        note:
          type: string
          nullable: true
          example: Make this again on Sunday

    CollectionItemWithRecipe:
      allOf:
        - $ref: '#/components/schemas/CollectionItem'
        - type: object
          properties:
            recipe:
              type: object
              description: Basic recipe object returned by Prisma include
              properties:
                recipe_id:
                  type: integer
                title:
                  type: string
                description:
                  type: string
                  nullable: true
                user_id:
                  type: integer
                is_public:
                  type: boolean
                created_at:
                  type: string
                  format: date-time
                updated_at:
                  type: string
                  format: date-time

    CollectionWithItems:
      allOf:
        - $ref: '#/components/schemas/Collection'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/CollectionItemWithRecipe'

    Review:
      type: object
      properties:
        review_id:
          type: integer
          example: 3
        user_id:
          type: integer
          example: 4
        recipe_id:
          type: integer
          example: 1
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        comment:
          type: string
          nullable: true
          example: Loved this recipe!
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
          example: Not found

    ValidationError:
      type: object
      properties:
        errors:
          type: array
          items:
            type: string
          example:
            - Email is required
            - Password must be between 8 and 64 characters long

paths:

  ################################
  # AUTH
  ################################
  /auth/signup:
    post:
      summary: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                  minLength: 8
                  maxLength: 32
                password:
                  type: string
                  minLength: 8
                  maxLength: 64
              required: [email, username, password]
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSignupMessage'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: Email or username already used
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error

  /auth/login:
    post:
      summary: Log in and receive an access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: Either email or username is required.
                username:
                  type: string
                  description: Either username or email is required.
                password:
                  type: string
                  minLength: 8
                  maxLength: 64
              required: [password]
      responses:
        '200':
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthToken'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error

  ################################
  # USERS
  ################################

  /users/me:
    get:
      summary: Get my profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      summary: Update my profile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                username:
                  type: string
                  minLength: 8
                  maxLength: 32
                password:
                  type: string
                  minLength: 8
                  maxLength: 64
              description: At least one of the fields is required.
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email or username already used
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete my profile
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Profile deleted
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{id}/role:
    patch:
      summary: Update a user's role (ADMIN only)
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                  enum: [USER, CREATOR, ADMIN]
              required: [role]
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  ################################
  # RECIPES
  ################################
  /recipes:
    get:
      summary: List public recipes
      parameters:
        - in: query
          name: q
          schema:
            type: string
          required: false
          description: Search term for recipe title.
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          required: false
          description: Page number (1-based).
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
          required: false
          description: Number of items per page, max 100.
      responses:
        '200':
          description: Paginated list of recipes
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecipeSummary'
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      pageSize:
                        type: integer
                      total:
                        type: integer
                      hasNext:
                        type: boolean
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a recipe
      description: Requires role CREATOR or ADMIN.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  minLength: 3
                  maxLength: 100
                description:
                  type: string
                  minLength: 10
                isPublic:
                  type: boolean
                  default: true
                servings:
                  type: integer
                  minimum: 1
                prepMinutes:
                  type: integer
                  minimum: 0
                cookMinutes:
                  type: integer
                  minimum: 0
                steps:
                  type: array
                  items:
                    $ref: '#/components/schemas/Step'
                ingredients:
                  type: array
                  description: Each ingredient must include name and unit.
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        minLength: 3
                        maxLength: 100
                      unit:
                        type: string
                        minLength: 1
                    required: [name, unit]
                tags:
                  type: array
                  items:
                    type: string
              required: [title, description, servings, prepMinutes, cookMinutes, steps, ingredients, tags]
      responses:
        '201':
          description: Recipe created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeSummary'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '409':
          description: Conflict
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /recipes/{id}:
    get:
      summary: Get recipe details
      description: Returns recipe details including steps, ingredients, and tags. Non-public recipes return 404 to unauthenticated users.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Recipe details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeDetail'
        '400':
          description: Invalid id
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error

    put:
      summary: Update recipe metadata
      description: Owner or ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                isPublic:
                  type: boolean
                servings:
                  type: integer
                prepMinutes:
                  type: integer
                cookMinutes:
                  type: integer
      responses:
        '200':
          description: Updated recipe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeSummary'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

    delete:
      summary: Delete a recipe
      description: Owner or ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted successfully
        '400':
          description: Invalid id
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
  /recipes/{id}/visibility:
    put:
      summary: Set recipe visibility
      description: Owner or ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isPublic:
                  type: boolean
              required: [isPublic]
      responses:
        '200':
          description: Updated visibility
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  isPublic:
                    type: boolean
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  /recipes/{id}/steps:
    post:
      summary: Replace all steps for a recipe
      description: Owner, CREATOR, or ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                steps:
                  type: array
                  items:
                    $ref: '#/components/schemas/Step'
              required: [steps]
      responses:
        '200':
          description: Updated list of steps
          content:
            application/json:
              schema:
                type: object
                properties:
                  steps:
                    type: array
                    items:
                      $ref: '#/components/schemas/Step'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  /recipes/{id}/ingredients:
    post:
      summary: Replace all ingredients for a recipe
      description: Owner, CREATOR, or ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ingredients:
                  type: array
                  items:
                    type: object
                    properties:
                      ingredientId:
                        type: integer
                        description: Optional existing ingredient id.
                      name:
                        type: string
                        description: Optional ingredient name (required by service).
                      unit:
                        type: string
                    required: [unit]
              required: [ingredients]
      responses:
        '200':
          description: Updated ingredient list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ingredients:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecipeIngredient'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  ################################
  # INGREDIENTS
  ################################
  /ingredients:
    get:
      summary: Search ingredients
      description: Search ingredients by name. If no query is provided, returns up to 50 ingredients.
      parameters:
        - in: query
          name: q
          required: false
          schema:
            type: string
          description: Search term for ingredient name.
      responses:
        '200':
          description: List of ingredients
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ingredient'
        '500':
          description: Server error

    post:
      summary: Create an ingredient
      description: CREATOR or ADMIN only.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: sugar
                unit:
                  type: string
                  nullable: true
                  example: grams
              required:
                - name
      responses:
        '201':
          description: Ingredient created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '400':
          description: name is required
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '409':
          description: Ingredient already exists
        '500':
          description: Server error

  /ingredients/{id}:
    get:
      summary: Get an ingredient by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Ingredient found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '400':
          description: Invalid id
        '404':
          description: Not found
        '500':
          description: Server error

    put:
      summary: Update an ingredient
      description: ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: brown sugar
                unit:
                  type: string
                  example: grams
              required:
                - name
      responses:
        '200':
          description: Ingredient updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '400':
          description: name is required
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '409':
          description: Duplicate name
        '500':
          description: Server error

    delete:
      summary: Delete an ingredient
      description: ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Server error

  ################################
  # COLLECTIONS + ITEMS
  ################################
  /collections:
    get:
      summary: List collections for the current user
      description: Returns collections owned by the authenticated user. Admin users may optionally filter by ownerId query parameter.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: ownerId
          schema:
            type: integer
          required: false
          description: Only available for ADMIN. Returns collections owned by the given user.
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Collection'
        '401':
          description: Unauthorized
        '500':
          description: Server error

    post:
      summary: Create a new collection
      description: Create a collection owned by the current user.
      security:
        - bearerAuth: []
      requestBody:
        description: Collection data
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Weeknight Dinners
              required:
                - name
      responses:
        '201':
          description: Collection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '500':
          description: Server error

  /collections/{id}:
    get:
      summary: Get a collection by ID
      description: Returns a collection and its items if the current user is the owner or an admin.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      responses:
        '200':
          description: Collection with items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionWithItems'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

    put:
      summary: Update a collection
      description: Update a collection's name. Only the owner or an admin can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Updated Collection Name
      responses:
        '200':
          description: Updated collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

    delete:
      summary: Delete a collection
      description: Delete a collection. Only the owner or an admin can delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      responses:
        '204':
          description: Collection deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

  /collections/{id}/items:
    post:
      summary: Add a recipe to a collection
      description: Add a recipe to a collection owned by the current user (or any collection if admin).
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recipeId:
                  type: integer
                  example: 1
                note:
                  type: string
                  nullable: true
                  example: Make this on Friday
              required:
                - recipeId
      responses:
        '201':
          description: Item added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionItem'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection or recipe not found
        '409':
          description: Recipe already in collection
        '500':
          description: Server error

  /collections/{id}/items/{itemId}:
    delete:
      summary: Remove a recipe from a collection
      description: Remove a recipe item from a collection. Only the owner or an admin can remove items.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
        - in: path
          name: itemId
          required: true
          description: Collection item ID
          schema:
            type: integer
      responses:
        '204':
          description: Item removed
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection or item not found
        '500':
          description: Server error

  ################################
  # REVIEWS
  ################################
  /recipes/{recipeId}/reviews:
    get:
      summary: List reviews for a recipe
      description: Returns all reviews for the given recipe.
      parameters:
        - in: path
          name: recipeId
          required: true
          schema:
            type: integer
          description: Recipe ID
      responses:
        '200':
          description: List of reviews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Review'
        '500':
          description: Server error

    post:
      summary: Create a review for a recipe
      description: Authenticated users may leave one review per recipe.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: recipeId
          required: true
          schema:
            type: integer
          description: Recipe ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  example: 4
                comment:
                  type: string
                  nullable: true
                  example: Pretty good overall
              required:
                - rating
      responses:
        '201':
          description: Review created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '404':
          description: Recipe not found
        '409':
          description: User already reviewed this recipe
        '500':
          description: Server error

  /reviews/{id}:
    put:
      summary: Update a review
      description: Only the review author or an admin can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Review ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  example: 3
                comment:
                  type: string
                  nullable: true
                  example: Changed my mind after making it again
      responses:
        '200':
          description: Updated review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Review not found
        '500':
          description: Server error

    delete:
      summary: Delete a review
      description: Delete a review. Only the review author or an admin can delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Review ID
          schema:
            type: integer
      responses:
        '204':
          description: Review deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Review not found
        '500':
          description: Server error
