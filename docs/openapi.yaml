openapi: 3.0.3
info:
  title: Recipe Tracker API
  version: 1.0.0
  description: >
    REST API for managing recipes, ingredients, collections, and reviews.

servers:
  - url: http://localhost:3000
    description: Local development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    User:
      type: object
      properties:
        userid:
          type: integer
          example: 1
        username:
          type: string
          example: "jasmine_biggs"
        email:
          type: string
          example: "jb@example.com"
        role:
          type: string
          enum: [USER, CREATOR, ADMIN]

    Ingredient:
      type: object
      properties:
        id:
          type: string
          example: "clz7f7b8m0000xv0p5s2p1n8"
        name:
          type: string
          example: "flour"
      required: [id, name]

    Step:
      type: object
      properties:
        order:
          type: integer
          example: 1
        text:
          type: string
          example: "Mix all dry ingredients"
      required: [order, text]

    RecipeSummary:
      type: object
      properties:
        id:
          type: string
          example: "clz7f7b8m0000xv0p5s2p1n8"
        title:
          type: string
          example: "Fluffy Pancakes"
        isPublic:
          type: boolean
          example: true
        avgRating:
          type: number
          format: float
          nullable: true
          example: 4.5
      required:
        - id
        - title
        - isPublic

    RecipeDetail:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        isPublic:
          type: boolean
        ownerId:
          type: string
        servings:
          type: integer
          nullable: true
        prepMinutes:
          type: integer
          nullable: true
        cookMinutes:
          type: integer
          nullable: true
        steps:
          type: array
          items:
            $ref: '#/components/schemas/Step'
        ingredients:
          type: array
          items:
            type: object
            properties:
              ingredientId:
                type: string
              name:
                type: string
              quantity:
                type: number
                example: 200
              unit:
                type: string
                example: "grams"
        tags:
          type: array
          items:
            type: string
            example: "breakfast"
        avgRating:
          type: number
          format: float
          nullable: true
      required:
        - id
        - title
        - isPublic

    Collection:
      type: object
      properties:
        collection_id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 4
        name:
          type: string
          example: "Jasmine's Saved Recipes"

    CollectionItem:
      type: object
      properties:
        collection_item_id:
          type: integer
          example: 10
        collection_id:
          type: integer
          example: 1
        recipe_id:
          type: integer
          example: 2
        note:
          type: string
          nullable: true
          example: "Make this again on Sunday"

    Review:
      type: object
      properties:
        review_id:
          type: integer
          example: 3
        user_id:
          type: integer
          example: 4
        recipe_id:
          type: integer
          example: 1
        rating:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        comment:
          type: string
          nullable: true
          example: "Loved this recipe!"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
          example: "Not found"

paths:

  ################################
  # RECIPES
  ################################

  /recipes:
    get:
      summary: List public recipes
      description: >
        Returns a paginated list of public recipes. Supports text search,
        tag filtering, and minimum average rating.
      parameters:
        - in: query
          name: q
          schema:
            type: string
          required: false
          description: Search term for recipe title.
        - in: query
          name: tag
          schema:
            type: string
          required: false
          description: Filter recipes that have the given tag.
        - in: query
          name: minRating
          schema:
            type: number
          required: false
          description: Minimum average rating to include.
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          required: false
          description: Page number (1-based).
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
          required: false
          description: Number of items per page, max 100.
      responses:
        '200':
          description: Paginated list of recipes
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecipeSummary'
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      pageSize:
                        type: integer
                      total:
                        type: integer
                      hasNext:
                        type: boolean
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Create a recipe
      description: >
        Create a new recipe. Only users with role CREATOR or ADMIN are allowed.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                  nullable: true
                isPublic:
                  type: boolean
                  default: true
                servings:
                  type: integer
                  nullable: true
                prepMinutes:
                  type: integer
                  nullable: true
                cookMinutes:
                  type: integer
                  nullable: true
                steps:
                  type: array
                  items:
                    $ref: '#/components/schemas/Step'
                ingredients:
                  type: array
                  items:
                    type: object
                    properties:
                      ingredientId:
                        type: string
                        nullable: true
                      name:
                        type: string
                        nullable: true
                      quantity:
                        type: number
                      unit:
                        type: string
                tags:
                  type: array
                  items:
                    type: string
              required:
                - title
      responses:
        '201':
          description: Recipe created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeSummary'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /recipes/{id}:
    get:
      summary: Get recipe details
      description: >
        Returns recipe details including steps, ingredients, tags, and avgRating.
        Non-public recipes are only visible to the owner or admins.
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Recipe details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeDetail'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error

    put:
      summary: Update recipe metadata
      description: >
        Update core fields of a recipe (title, description, visibility, servings, times).
        Only the owner or admins can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                isPublic:
                  type: boolean
                servings:
                  type: integer
                prepMinutes:
                  type: integer
                cookMinutes:
                  type: integer
      responses:
        '200':
          description: Updated recipe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecipeSummary'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

    delete:
      summary: Delete a recipe
      description: >
        Delete a recipe. Only the owner or admins can delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted successfully
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  /recipes/{id}/visibility:
    put:
      summary: Set recipe visibility
      description: >
        Set the isPublic flag on a recipe. Only the owner or admins can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                isPublic:
                  type: boolean
              required:
                - isPublic
      responses:
        '200':
          description: Updated visibility
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  isPublic:
                    type: boolean
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  /recipes/{id}/steps:
    post:
      summary: Replace all steps for a recipe
      description: >
        Replace all steps of a recipe in one request. Only the owner or admins can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                steps:
                  type: array
                  items:
                    $ref: '#/components/schemas/Step'
              required:
                - steps
      responses:
        '200':
          description: Updated list of steps
          content:
            application/json:
              schema:
                type: object
                properties:
                  steps:
                    type: array
                    items:
                      $ref: '#/components/schemas/Step'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  /recipes/{id}/ingredients:
    post:
      summary: Replace all ingredients for a recipe
      description: >
        Replace all ingredients of a recipe. Ingredients can be referenced by ID
        or created by name. Only the owner or admins can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ingredients:
                  type: array
                  items:
                    type: object
                    properties:
                      ingredientId:
                        type: string
                        nullable: true
                      name:
                        type: string
                        nullable: true
                      quantity:
                        type: number
                      unit:
                        type: string
              required:
                - ingredients
      responses:
        '200':
          description: Updated ingredient list
          content:
            application/json:
              schema:
                type: object
                properties:
                  ingredients:
                    type: array
                    items:
                      type: object
                      properties:
                        ingredientId:
                          type: string
                        name:
                          type: string
                        quantity:
                          type: number
                        unit:
                          type: string
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found

  ################################
  # INGREDIENTS
  ################################

  /ingredients:
    get:
      summary: Search ingredients
      description: >
        Search ingredients by name. If no query is provided, returns up to 50 ingredients.
      parameters:
        - in: query
          name: q
          required: false
          schema:
            type: string
          description: Search term for ingredient name.
      responses:
        '200':
          description: List of ingredients
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ingredient'
        '500':
          description: Server error

    post:
      summary: Create an ingredient
      description: >
        Create a new ingredient. Only users with role CREATOR or ADMIN can create ingredients.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "sugar"
              required:
                - name
      responses:
        '201':
          description: Ingredient created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '400':
          description: name is required
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '409':
          description: Ingredient already exists
        '500':
          description: Server error

  /ingredients/{id}:
    get:
      summary: Get an ingredient by ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Ingredient found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '404':
          description: Not found
        '500':
          description: Server error

    put:
      summary: Update an ingredient
      description: >
        Update an ingredient's name. ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "brown sugar"
              required:
                - name
      responses:
        '200':
          description: Ingredient updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ingredient'
        '400':
          description: name is required
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '409':
          description: Duplicate name
        '500':
          description: Server error

    delete:
      summary: Delete an ingredient
      description: >
        Delete an ingredient by ID. ADMIN only.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Not found
        '500':
          description: Server error

  ################################
  # COLLECTIONS + ITEMS
  ################################

  /collections:
    get:
      summary: List collections for the current user
      description: >
        Returns collections owned by the authenticated user.  
        Admin users may optionally filter by ownerId query parameter.
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: ownerId
          schema:
            type: integer
          required: false
          description: Only available for ADMIN. Returns collections owned by the given user.
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Collection'
        '401':
          description: Unauthorized
        '500':
          description: Server error

    post:
      summary: Create a new collection
      description: Create a collection owned by the current user.
      security:
        - bearerAuth: []
      requestBody:
        description: Collection data
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Weeknight Dinners"
              required:
                - name
      responses:
        '201':
          description: Collection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '500':
          description: Server error

  /collections/{id}:
    get:
      summary: Get a collection by ID
      description: >
        Returns a collection and its items if the current user is the owner or an admin.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      responses:
        '200':
          description: Collection with items
          content:
            application/json:
              schema:
                type: object
                properties:
                  collection_id:
                    type: integer
                  user_id:
                    type: integer
                  name:
                    type: string
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/CollectionItem'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

    put:
      summary: Update a collection
      description: >
        Update a collection's name. Only the owner or an admin can update.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Updated Collection Name"
      responses:
        '200':
          description: Updated collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

    delete:
      summary: Delete a collection
      description: >
        Delete a collection. Only the owner or an admin can delete.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      responses:
        '204':
          description: Collection deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection not found
        '500':
          description: Server error

  /collections/{id}/items:
    post:
      summary: Add a recipe to a collection
      description: >
        Add a recipe to a collection owned by the current user (or any collection if admin).
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recipeId:
                  type: integer
                  example: 1
                note:
                  type: string
                  nullable: true
                  example: "Make this on Friday"
              required:
                - recipeId
      responses:
        '201':
          description: Item added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionItem'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection or recipe not found
        '409':
          description: Recipe already in collection
        '500':
          description: Server error

  /collections/{id}/items/{itemId}:
    delete:
      summary: Remove a recipe from a collection
      description: >
        Remove a recipe item from a collection. Only the owner or an admin can remove items.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Collection ID
          schema:
            type: integer
        - in: path
          name: itemId
          required: true
          description: Collection item ID
          schema:
            type: integer
      responses:
        '204':
          description: Item removed
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Collection or item not found
        '500':
          description: Server error

  ################################
  # REVIEWS (avgRating)
  ################################

  /recipes/{recipeId}/reviews:
    get:
      summary: List reviews for a recipe
      description: >
        Returns all reviews for the given recipe.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: recipeId
          required: true
          schema:
            type: integer
          description: Recipe ID
      responses:
        '200':
          description: List of reviews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Review'
        '500':
          description: Server error

    post:
      summary: Create a review for a recipe
      description: >
        Create a review for the given recipe.  
        Each user may leave at most one review per recipe. avgRating is updated automatically.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: recipeId
          required: true
          schema:
            type: integer
          description: Recipe ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  example: 4
                comment:
                  type: string
                  nullable: true
                  example: "Pretty good overall"
              required:
                - rating
      responses:
        '201':
          description: Review created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '404':
          description: Recipe not found
        '409':
          description: User already reviewed this recipe
        '500':
          description: Server error

  /reviews/{id}:
    put:
      summary: Update a review
      description: >
        Update the rating and/or comment of an existing review.  
        Only the review author or an admin can update. avgRating is updated automatically.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Review ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rating:
                  type: integer
                  minimum: 1
                  maximum: 5
                  example: 3
                comment:
                  type: string
                  nullable: true
                  example: "Changed my mind after making it again"
      responses:
        '200':
          description: Updated review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Review'
        '400':
          description: Invalid input
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Review not found
        '500':
          description: Server error

    delete:
      summary: Delete a review
      description: >
        Delete a review. Only the review author or an admin can delete.
        avgRating is updated automatically.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Review ID
          schema:
            type: integer
      responses:
        '204':
          description: Review deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Review not found
        '500':
          description: Server error
